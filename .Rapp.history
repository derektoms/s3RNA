persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,ylog=TRUE)
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,ylog=FALSE)
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,zlab="")
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,zlab=c(""))
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,expand=2)
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,axes=FALSE)
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=40,cex.axis=.6,cex.lab=.6,ticktype="simple")
persp(rpe.rsm, ~x1*x2, at=xs(rpe.rsm), contours = "col", col=rainbow(40),zlab="rate1 (a.u. / a.t.)",xlabs=c("chetomin, nM","niacinamide, mM"),theta=110,cex.axis=.6,cex.lab=.6,ticktype="simple")
q()
library(shiny)#
library(shinyjs)#
#
load_data <- function() {#
  Sys.sleep(2)#
  hide("loading_page")#
  show("main_content")#
}#
#
ui <- fluidPage(#
  useShinyjs(),#
  div(#
    id = "loading_page",#
    h1("Loading...")#
  ),#
  hidden(#
    div(#
      id = "main_content",#
      "Data loaded, content goes here"#
    )#
  )#
)#
#
server <- function(input, output, session) {#
  load_data()#
}#
#
shinyApp(ui = ui, server = server)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment.")),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
           mainPanel(#
               img(src="overview.png",width="100%")#
               ))#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads..."))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment.")),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
           mainPanel(#
               img(src="overview.png",width="100%")#
               ))#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment."),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
         mainPanel(#
               img(src="overview.png",width="100%")#
               ))#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
jscode <- '#
$(function() {#
  var $els = $("[data-proxy-click]");#
    $.each(#
    $els,#
    function(idx, el) {#
      var $el = $(el);#
      var $proxy = $("#" + $el.data("proxyClick"));#
      $el.keydown(function (e) {#
        if (e.keyCode == 13) {#
          $proxy.click();#
        }#
      });#
    }#
  );#
});#
'#
#
jscode2 <- '#
$(function() {#
    $(#receptorMain li a[data-value="Gene-level Expression"]).hide();#
    $(#receptorMain li a[data-value="Sample-level Expression"]).hide();#
});#
'#
#########################################
#$#$#$#$#$#$#$    UI     $#$#$#$#$#$#$#$#
#########################################
#
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment."),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
         mainPanel(#
               img(src="overview.png",width="100%")#
               )#
        )),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by "),#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment."),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
         mainPanel(#
               img(src="overview.png",width="100%")#
               )#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by "),#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment."),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
         mainPanel(#
               img(src="overview.png",width="100%")#
               )#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control", uiOutput("QC")),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                    column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                    column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot")))#
            )#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment.")),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               )),#
         mainPanel(#
               img(src="overview.png",width="100%")#
               )#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control", uiOutput("QC")),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                    column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                    column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot")))#
            )#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
    show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
    tabPanel("Start here",#
   value ="startPanel",#
   h3("Welcome to receptoR!"),#
   hr(),#
   sidebarLayout(#
       sidebarPanel(#
           p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
           tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
           hr(),#
           #div#
           p("There are two ways to begin using receptor, either by ", actionLink("linkSearch","searching for expression data"), " to design your own experiment, or by ", actionLink("linkLoad","loading and analysing an existing experiment.")),#
#
           hr(),#
           p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
           p("Copyright (C) 2019, code licensed under GPLv3")#
           #/div#
           ),#
     mainPanel(#
           img(src="overview.png",width="100%")#
           )#
    )),#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control", uiOutput("QC")),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                    column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                    column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot")))#
            )#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
    show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
    tabPanel("Start here",#
   value ="startPanel",#
   h3("Welcome to receptoR!"),#
   hr(),#
   sidebarLayout(#
       sidebarPanel(#
           ),#
     mainPanel(#
           img(src="overview.png",width="100%")#
           )#
    )),#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control", uiOutput("QC")),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                    column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                    column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot")))#
            )#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
    show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...", style = "color:white;")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment.")),#
               # To proceed, click \'Search for datasets\', above"),#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
           mainPanel(#
               img(src="overview.png",width="100%")#
               ))#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
        show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...")))#
)#
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment.")),#
#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
           mainPanel(#
               img(src="overview.png",width="100%")#
               ))#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
    show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...",style = "color:white;"))#
)#
)
)
ui <- fluidPage(#
tags$head(tags$script(HTML(jscode))),#
tags$head(tags$script(HTML(jscode2))),#
tags$head(tags$link(rel = "stylesheet", type = "text/css", href = "receptor.CSS")),#
tags$head(tags$link(rel = "stylesheet", href = "https://use.fontawesome.com/releases/v5.6.3/css/all.css",  integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/", crossorigin="anonymous"),#
tags$head(tags$style(#
        type="text/css",#
        "#QC img {max-width: 100%; width: 100%; height: auto}"#
    ))#
#
),#
# tags$script(HTML("$('body').addClass('fixed);")),#
shinyjs::useShinyjs(),#
use_waiter(include_js = FALSE),#
navbarPage("receptoR",#
    id = "receptorMain",#
    theme = shinytheme("spacelab"),#
#
# Start page  ------------------------------------------------------------------------------#
#
    tabPanel("Start here",#
       value ="startPanel",#
       h3("Welcome to receptoR!"),#
       hr(),#
       sidebarLayout(#
           sidebarPanel(#
               # h4("An automated hypothesis generation software to identify cellular signaling pathways from transcriptomics data"),#
               p("This software allows you to browse and analyze public transcriptomics data. This is based on the idea that each cell type expresses a particular suite of cellular receptors that drive its behaviour."),#
               tags$ol(tags$li("A cell transcribes mRNA that will be translated into functional receptor proteins."),tags$li("Isolated RNA from this cell is converted to labeled cDNA, which is hybridized to an oligonucleotide probe array to measure expression."),tags$li("Each array represents a snapshot of a specific transcriptome. Thousands of these have been digitized and made publicly available."),tags$li("By mining this data, we can predict which receptors are expressed by our cells or tissues of interest to direct bioengineering strategies.")),#
               hr(),#
               #div#
               p("There are two ways to begin using receptor, either by ",#
               actionLink("linkSearch","searching for expression data"),#
               " to design your own experiment, or by ",#
               actionLink("linkLoad","loading and analysing an existing experiment.")),#
#
               hr(),#
               p("code created by Derek Toms, Qing Yun Tong and Matthew Workentine"),#
               p("Copyright (C) 2019, code licensed under GPLv3")#
               #/div#
               ),#
           mainPanel(#
               img(src="overview.png",width="100%")#
               ))#
        ),#
#
# Search Transcriptome Database ------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Search Transcriptome Database",#
       value = "searchPanel",#
       includeCSS("www/receptor.CSS"),#
       h3("Organize publicly available expression data"), ## change#
       hr(),#
       sidebarLayout(#
       sidebarPanel(#
           # style = "position:fixed;width:30%",#
           conditionalPanel(condition="input.searchpanel==1",#
           h4("Search Expression Data"),#
           p("Begin by searching the Gene Expression Omnibus (GEO) database for publicly available transcriptome data. Depending on availability, these may be available for specific tissues or isolated cell types. In the next step, these samples will be assigned to one of three categories to determine differential expression between sample types."),#
           br(),#
           radioButtons("gplSelection", "Choose species:", choices = c("Mouse (GPL1261)" = "mouse", "Human (GPL570)" = "human")),#
           tagAppendAttributes(textInput("searchText", "Enter search terms:", value = ""),`data-proxy-click` = "searchButton"),#
           helpText("Search for multiple keywords using the boolean operators 'AND','OR','NOT', and the wildcard '*'. For example: 'liver AND hepa* NOT brain'."),#
           actionButton("searchButton", "Search for arrays"),#
           # actionButton("uploadButton", "I have my own data to analyze"),#
           hr(),#
           # HTML(paste("These experiments, each containing multiple biological samples, are refered to as ",span("G",style="font-weight:bold"),"EO data ",span("se",style="font-weight:bold"),"ries (GSE). Each ",span("G",style="font-weight:bold"),"EO ",span("s",style="font-weight:bold"), "a",span("m",style="font-weight:bold"),"ple (GSM) represents a digitized transcriptional snapshot.",sep="")),#
           p("Click \'Add array to experiment\' to retrieve array (GSM) information and then click on the \'Assign\' tab above to organize this data for analysis."),#
           actionButton("addButton", "Add array to experiment")),#
           conditionalPanel(condition="input.searchpanel==2",#
           h4("Define the categories that you wish to assign each sample (GSM) for comparison."),#
           p("Each sample of interest should be assigned to a category. In this way, experimental comparisons can be performed to determine differential expression between categories. A minimum of two and a maximum of three categories should be defined. If you are only interested in a single sample type it is recommended that this is compared to a 'background' sample to identify enriched receptor genes."),#
#
           tags$div(class="inputWithIcon", textInput("cat1", label=NULL, placeholder="Category 1 (e.g., pancreatic endocrine cells)"), tags$span(style="color:#E41A1C",icon("circle",class="fa-2x"))),#
#
           tags$div(class="inputWithIcon",textInput("cat2", label=NULL, placeholder="Category 2 (e.g., photoreceptors)"), tags$span(style="color:#377EB8",icon("circle",class="fa-2x"))),#
           tags$div(class="inputWithIcon",textInput("cat3", label=NULL, placeholder="Category 3 (optional)"),#
           tags$span(style="color:#4DAF4A",icon("circle",class="fa-2x"))),#
           hr(),#
           h4("Highlight samples, then click to Assign them to the specificed category."),#
           p("Using the table at right and the drop down menu below, click on samples and \'Assign\' them to different categories. Samples can be filtered using the search bar."),#
           fluidRow(column(8,uiOutput("categorySelect")),#
           column(4,actionButton("assignButton", "Assign")))#
           ),#
           conditionalPanel(condition="input.searchpanel==3",#
               h4("Thank you for using receptoR!"), # this should be slightly more informative, along the lines of Process data#
               p(" To download and process raw files, first name your dataset and any comments/bugs/questions/requests in the box below. Click the \'Process\' button to retrieve the raw files from the NCBI server and process them based on the  categories you assigned them to. You can save a local copy of your work with the \'Download Report\' button"), # move this off of this page; separate "Help/Comments" button#
               textInput("downloadId","Dataset name",placeholder="Please enter a memorable name for this dataset"), # needs to be mandatory (or filled by default)#
               textAreaInput("comments","Comments",width="100%",height="100px",resize="vertical"),#
               downloadButton("report","Download Report"),#
               actionButton("downloadCEL","Process")),#
           hr(),#
               # Help banner on the bottom -------------------------#
           # h4("Help me!"),#
           p("Click ",actionLink("linkReset","here "),"to start again.")#
       ),#
       mainPanel(#
           # Search GSE based on species#
        tabsetPanel(#
        tabPanel("Search", value=1,#
            h4("GEO microarrays (\'GSM\') matching your search query"), # return search here!#
            DT::dataTableOutput("searchResultsGSM")#
        ),#
        # Assign samples to categories ------------------------------------------------------#
        tabPanel("Assign", value=2,#
            h4("Assign individual arrays (GSM) to categories of your choosing"),#
            DT::dataTableOutput("gsm_table")#
        ),#
        # This will be where the CEL files are downloaded (confirmation, etc) ------------#
        tabPanel("Process", value=3,#
        h4("Please confirm samples are properly categorized before proceeding"),#
        p("Expression samples annotated:"),#
                DT::dataTableOutput("finishedtable")#
        ),#
        id = "searchpanel"#
        )#
        )#
        )#
    ),#
# Load Gene Expression Datasets ---------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
# ------------------------------------------------------------------------------------------#
#
    tabPanel("Load Expression Datasets",#
        value="expressionPanel",#
        h3("Pick from user-defined experiments to perform analyses"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Load Experiment"),#
            uiOutput("loadUserExperiments"),#
            hr(),#
            checkboxGroupInput("genelist", "Select a receptor type to analyze", #
                  choices = NULL),#
            br(),#
            selectInput("gene", "Select additional non-receptor coding gene(s) to include in the analysis.", choices = NULL, multiple = TRUE),#
            helpText("Search by gene symbol; availability of a given gene is based on microarray probe annotations."),#
            downloadButton("reportDEG","Download differential gene expression analysis"),#
            helpText("This Microsoft Excel file (.XSLX) contains all differentially expressed genes among these tissues. It can be further used for downstream analyses including functional enrichment analysis.")#
        ),#
        mainPanel(#
            tabsetPanel(type="tabs",selected="Gene-by-gene Expression",#
            tabPanel("Quality control",#
            uiOutput("QC")#
        ),#
            # tabPanel("Experimental design",h4("Category definitions and contrasts"),p("Coming soon!")),#
            tabPanel("Gene-by-gene Expression",#
                fluidRow(#
                column(6, h4("Average Expression"), DT::dataTableOutput("genes")),#
                column(6, h4("Gene Violin Plot"), plotOutput("singleGenePlot"))#
            )))#
        )#
        )#
    ),#
    # Magnitude expression tab ------------------------------------------------------------------------------#
    tabPanel("Gene-level Expression",#
        h3("Compare genes based on absolute expression and differential expression between experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Gene expression"),#
            checkboxGroupInput("tissues", label = "Select tissues to include",#
            choices = NULL, selected = NULL),#
            br(),#
            checkboxInput("de_state", label = "Show differential expressed only", value = TRUE),#
            checkboxGroupInput("de", label = "Choose comparison(s) to show", choices = NULL, selected = NULL),#
            br(),#
            conditionalPanel(condition="input.absexpanel==1",#
                h5("Heatmap parameters"),#
                checkboxInput("hm_probes", "Show probe-level", value = FALSE),#
                checkboxInput("hm_gsm", "Show GSM (column names)", value = TRUE),#
                checkboxInput("hm_rownames", "Show gene symbols (row names)", value = TRUE),#
                checkboxInput("hm_col_cluster", "Cluster columns", value = TRUE),#
                checkboxInput("hm_row_cluster", "Cluster rows", value = TRUE),#
                numericInput("hm_width", "Plot width (px)", value = 900, min = 100, max = 2400, step = 10),#
                numericInput("hm_height", "Plot height (px)", value = 1200, min = 100, max = 2400, step = 10))#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Heatmap", value=1, h4("Cluster analysis and a heatmap representation of gene expression."), p("Genes with similar expression patterns will cluster as rows, while individual microarrays cluster as columns."), uiOutput("heatmap_ui")),#
            tabPanel("Summary boxplots", h4("Boxplots of expression data by tissue."), plotOutput("overallPlot", height = 600)),#
            tabPanel("By-gene boxplots", h4("Boxplots of expression data by gene."), plotOutput("byGenePlot", height = 600)),#
            id = "absexpanel"#
        )#
        )#
        )#
    ),#
#
    # Mixomics tab ---------------------------------------------#
    tabPanel("Sample-level Expression",#
        h3("Compare trends in samples based on experimental groups"),#
        hr(),#
        sidebarLayout(#
        sidebarPanel(#
            h4("Sample expression"),#
            checkboxGroupInput("pls_tissues", label = "Select tissues to inclued",#
            choices = NULL, selected = NULL),#
            # checkboxInput("pls_probe", "Perform PLS-DA at probe level", value = FALSE),#
            br(),#
            h4("Gene contribution plot"),#
            uiOutput("numGenesUI"),#
            radioButtons("pls_ncomp", "Select component for gene contribution plot", choices = c(1,2)),#
            br()#
            # downloadButton("pls_download", "Download gene contribution data")#
        ),#
        mainPanel(#
            tabsetPanel(type = "tabs",#
            tabPanel("Discriminant Analysis", h4("Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)  selects genes that are informative about a specific group. "), plotOutput("indPlot", height = 800)),#
            tabPanel("Component loadings plot", h4("Gene contribution to each principle component."), p("The longer the bar (in either direction) the more that gene contributes to that component."), plotOutput("contribPlot", height = 800)),#
            tabPanel("Circle variance", h4("Circle variance projections onto tissue."), p("Strongly correlated genes are projected in the same direction from the origin; the greater the distance the stronger the association."), plotOutput("varPlot", height = 800))#
        ),#
        position = c("right","left"),#
        fluid = TRUE#
        )#
        )#
    ),#
    show_waiter_on_load(tagList(#
        spin_three_bounce(),#
        span("Please wait while receptoR loads...",style = "color:white;")))#
)#
)
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/app_data_20190731-1441.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/app_data_20190731-1443.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/app_data_20190731-1955.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/app_data_20190731-2241.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/app_data_20190731-2252.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-1441.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-1443.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-1955.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-2217.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-2234.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-2241.rda")
load("/Users/derektoms/Desktop/shiny-server/receptoR/data/final_processed_data_20190731-2252.rda")
q()
library(devtools)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(hexbin)#
library(rnaseqGene) # loads 'ggplot2' and 'RColorBrewer'#
library(DESeq2)#
library(vsn)#
library(data.table)#
library(VennDiagram)#
library(ggplots2)#
library(BioCircos)#
library(RColorBrewer)#
library(rmarkdown)#
library(EnhancedVolcano)#
##
# miRReads <- list(raw.count = miwi, col.dat = micoldata)#
# snoRReads <- list(raw.count = all.sno.reads, col.dat = samples)#
# save(miRReads, snoRReads,file="raw-miR-snoR.rda")#
##
load("~/Documents/Manuscripts/Nuclear microRNA/raw-miR-snoR.rda")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
desat = function(cols, sat=0.5) {#
    X <- diag(c(1, sat, 1)) %*% rgb2hsv(col2rgb(cols))#
    hsv(X[1,], X[2,], X[3,])#
}#
#
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
# Colour space#
set1<-brewer.pal(4,"Set1")#
lite1<-brewer.pal(4,"Pastel1")#
ann_col <- list(size=c(small=set1[1],large=set1[2]),subcell=c(nucleus=set1[3],cytosol=set1[4]))#
grad_col <- colorRampPalette(brewer.pal(9, "YlOrBr"))(100)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
mirMat <- DESeqDataSetFromMatrix(countData = miRReads$raw.count, colData = miRReads$col.dat, design=~size*subcell)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
mirMat$group <- factor(paste0(mirMat$size,mirMat$subcell)) # for use in group-base classification#
mirMat$Batch <- factor(mirMat$Batch)#
design(mirMat)<-~size*subcell+Batch ## final model#
#
mirMat ## data set object#
# class: DESeqDataSet#
# dim: 416 16#
# metadata(1): version#
# assays(1): counts#
# rownames(416): ssc-let-7a ssc-let-7c ... ssc-miR-chr2_15576#
#   ssc-miR-chr3_17659#
# rowData names(0):#
# colnames(16): cs1 cl2 ... nl4 nl2#
# colData names(6): X size ... Batch group#
## Multi-factorial     dds1#
dds1<-DESeq(mirMat)#
#
## Group-based         dds2#
### As recommended online, use size and subcellular localization to make groups for contrasts#
#
design(mirMat) <- ~group+Batch#
dds2<-DESeq(mirMat)#
#
## Full linear model, two factor#
sizes<-results(dds1, contrast=c("size","small","large"))#
locals<-results(dds1, contrast=c("subcell","cytosol","nucleus"))#
#
## Specific groupings (comparable to Ram's analysis)#
nuc.sizes<-results(dds2, contrast=c("group","largenucleus","smallnucleus")) # 7; we got 378 back!#
cyt.sizes<-results(dds2, contrast=c("group","largecytosol","smallcytosol")) # 0#
lg.local<-results(dds2, contrast=c("group","largenucleus","largecytosol")) # 83#
sm.local<-results(dds2, contrast=c("group","smallnucleus","smallcytosol")) # 101#
#
sizes[which(sizes$padj<0.1),] # there are no significant values! most are .99#
locals[which(locals$padj<0.1),] # but plenty of significant differences here! 83 with padj<0.1#
#
s<-locals#
s[which(s$padj<0.1),] # replace s to calculate for the comparisons above#
summary(s)#
## Check distribution of p-values#
ggplot(as(s, "data.frame"), aes(x = pvalue)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
pcadat<-DESeq2::plotPCA(mirRLOG,intgroup=c("size","subcell","Batch"),returnData=TRUE)#
percentVar <- round(100 * attr(pcadat, "percentVar"))#
ggplot(pcadat, aes(x = PC1, y = PC2, color = size, shape = subcell)) +#
  geom_point(size =3) +#
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +#
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +#
  coord_fixed() + scale_shape_discrete(name="subcellular \nlocation",labels=c("nuclear","cytoplasmic")) + scale_color_manual(name="GC size",values=ann_col$size) + labs(title="Principle component analysis")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
mirLOG <- normTransform(dds1)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
pcadat<-DESeq2::plotPCA(mirRLOG,intgroup=c("size","subcell","Batch"),returnData=TRUE)#
percentVar <- round(100 * attr(pcadat, "percentVar"))#
ggplot(pcadat, aes(x = PC1, y = PC2, color = size, shape = subcell)) +#
  geom_point(size =3) +#
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +#
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +#
  coord_fixed() + scale_shape_discrete(name="subcellular \nlocation",labels=c("nuclear","cytoplasmic")) + scale_color_manual(name="GC size",values=ann_col$size) + labs(title="Principle component analysis")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
mirRLOG <-rlog(dds1,blind=FALSE)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
pcadat<-DESeq2::plotPCA(mirRLOG,intgroup=c("size","subcell","Batch"),returnData=TRUE)#
percentVar <- round(100 * attr(pcadat, "percentVar"))#
ggplot(pcadat, aes(x = PC1, y = PC2, color = size, shape = subcell)) +#
  geom_point(size =3) +#
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +#
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +#
  coord_fixed() + scale_shape_discrete(name="subcellular \nlocation",labels=c("nuclear","cytoplasmic")) + scale_color_manual(name="GC size",values=ann_col$size) + labs(title="Principle component analysis")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
snoMat2 <- DESeqDataSetFromMatrix(countData = snoRReads$raw.count, colData = snoRReads$col.dat, design=~size+batch)#
#
## snoRNA comparison, combining all localizations dds2s#
dds2s <- DESeq(snoMat2)#
sno.size2 <- results(dds2s,contrast = c("size","small","large"))#
sno.size2[which(sno.size2$padj<0.1),]
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
design(snoMat2) <- ~size*subcell+batch#
dds3s<-DESeq(snoMat2)#
resultsNames(dds3s)#
# [1] "Intercept" "size_small_vs_large" "local_nuc_vs_cyt"#
# [4] "batch_2_vs_1" "sizesmall.localnuc"#
#
# sno.size.subcell <- results(dds3s,contrast = "sizesmall.subcellnuc")#
# sno.size.subcell[which(sno.size.subcell$padj<0.1),] # no interaction term either#
#
design(snoMat2) <- ~subcell+batch#
dds4s<-DESeq(snoMat2)#
sno.subcell <- results(dds4s, contrast = c("subcell","nuc","cyt"))#
sno.subcell[which(sno.subcell$padj<0.1),] #112#
ggplot(as(sno.subcell, "data.frame"), aes(x = padj)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0) # 112 DEGs
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
sno.subcell <- results(dds3s, contrast = c("subcell","nuc","cyt"))#
sno.subcell[which(sno.subcell$padj<0.1),] #112
sno.subcell
dds3s
resultsNames(dds3s)
resultsNames(dds4s)
design(snoMat2) <- ~subcell+batch#
dds4s<-DESeq(snoMat2)#
sno.subcell <- results(dds3s, contrast = c("subcell","nuc","cyt"))#
sno.subcell[which(sno.subcell$padj<0.1),] #112#
ggplot(as(sno.subcell, "data.frame"), aes(x = padj)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0) # 112 DEGs#
locres1s <- lfcShrink(dds4s, coef="subcell_nucleus_vs_cytosol", type="apeglm")
resultsNames(dds4s)
resultsNames(dds3s)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
snoMat <- DESeqDataSetFromMatrix(countData = snoRReads$raw.count, colData = snoRReads$col.dat, design=~size+batch)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
snoMat$group <- factor(paste0(snoMat$size,snoMat$subcell)) # for use in group-base classification
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
snoMat$Batch <- factor(snoMat$batch)
snoMat
snoMat$Batch
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
design(snoMat)<-~size*subcell+batch ## final model
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
ddsno <- DESeq(snoMat)
resultsNames(ddsno)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
design(snoMat) <- ~group+batch#
ddsnog<-DESeq(snoMat)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
sno.subcell <- results(ddsno, contrast = c("subcell","nuc","cyt"))
resultsNames(ddsno)
sizes<-results(dds1, contrast=c("size","small","large"))
sizesno<-results(ddsno, contrast=c("size","small","large"))
ddsno
ddsno$subcell
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
sno.size<-results(ddsno, contrast=c("size","small","large"))#
sno.subcell <- results(ddsno, contrast = c("subcell","nucleus","cytosol"))
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
sno.subcell[which(sno.subcell$padj<0.1),] #112
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
ggplot(as(sno.subcell, "data.frame"), aes(x = padj)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0) # 112 DEGs#
locres1s <- lfcShrink(ddsno, coef="subcell_nucleus_vs_cytosol", type="apeglm")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
DESeq2::plotMA(locres1s, ylim = c(-2.8, 2.8), main="Relative abundance of snoRNA in the nucleus")
sno.nuc.sizes<-results(ddsnog, contrast=c("group","largenuc","smallnuc")) # 0#
sno.cyt.sizes<-results(ddsnog, contrast=c("group","largecyt","smallcyt")) # 0#
sno.lg.local<-results(ddsnog, contrast=c("group","largenuc","largecyt")) # 66#
sno.sm.local<-results(ddsnog, contrast=c("group","smallnuc","smallcyt")) # 71
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
sno.nuc.sizes<-results(ddsnog, contrast=c("group","largenucleus","smallnucleus")) # 0#
sno.cyt.sizes<-results(ddsnog, contrast=c("group","largecytosol","smallcytosol")) # 0#
sno.lg.local<-results(ddsnog, contrast=c("group","largenucleus","largecytosol")) # 66#
sno.sm.local<-results(ddsnog, contrast=c("group","smallnucleus","smallcytosol")) # 71
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
s<-sno.sm.local#
s[which(s$padj<0.1),] # replace s to calculate for the comparisons above
s<-sno.cyt.sizes
s[which(s$padj<0.1),] # replace s to calculate for the comparisons above
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
DESeq2::plotMA(locres1s, ylim = c(-2.8, 2.8), main="Relative abundance of snoRNA in the nucleus")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
DESeq2::plotMA(locres1s, ylim = c(-2.8, 2.8), main="Relative abundance of snoRNA in the nucleus")#
with(locres1s[sno.lgV,], {#
    points(baseMean, log2FoldChange, col=ann_col$size[2], lwd=2)#
    text(baseMean, log2FoldChange, sno.lgV, pos=3, col=ann_col$size[2],cex=0.5)#
})#
with(locres1s[sno.smV,], {#
    points(baseMean, log2FoldChange, col=ann_col$size[1], lwd=2)#
    text(baseMean, log2FoldChange, sno.smV, pos=3, col=ann_col$size[1],cex=0.5)#
})
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
keyvals <- rep("grey",nrow(locres1s))#
names(keyvals) <- rep('similar expression',nrow(locres1s))#
#
keyvals[which(locres1s$log2FoldChange > 1)] <- ann_col$subcell[1]#
names(keyvals)[which(locres1s$log2FoldChange > 1)] <- 'nucleus-enriched'#
#
keyvals[which(locres1s$log2FoldChange < -1)] <- ann_col$subcell[2]#
names(keyvals)[which(locres1s$log2FoldChange < -1)] <- 'cytoplasm-enriched'#
#
## optionally add difference of LGC and SGC (i.e. genes that only differ in their subcellular location in one group)#
keyvals[which(rownames(locres1s) %in% pull(lg.loc))] <- ann_col$size[2]#
names(keyvals)[which(rownames(locres1s) %in% pull(lg.loc))] <- 'size: LGC'#
keyvals[which(rownames(locres1s) %in% pull(sm.loc))] <- ann_col$size[1]#
names(keyvals)[which(rownames(locres1s) %in% pull(sm.loc))] <- 'size: SGC'#
#
## Now adding shape information based on the snoRNA class#
snoRAnnotate <- read.csv(file = "piRNA_snoRNA/snoRNA-RFAM.csv", header = TRUE, stringsAsFactors = FALSE)#
sno.names <- substring(snoRAnnotate$x,3)#
CD <- snoRAnnotate$x[which(snoRAnnotate$class=="C/D")]#
HACA <- snoRAnnotate$x[which(snoRAnnotate$class=="H/ACA")]#
#
keyvals.shape <- rep(16,nrow(locres1s))#
names(keyvals.shape) <- rep('uncategorized',nrow(locres1s))#
#
keyvals.shape[which(rownames(locres1s) %in% CD)] <- 17#
names(keyvals.shape)[which(rownames(locres1s) %in% CD)] <- 'C/D'#
#
keyvals.shape[which(rownames(locres1s) %in% HACA)] <- 15#
names(keyvals.shape)[which(rownames(locres1s) %in% HACA)] <- 'H/ACA'#
#
# keyvals.shape[which(rownames(locres1s) %in% pull(lg.loc))] <- 1#
# names(keyvals.shape)[which(rownames(locres1s) %in% pull(lg.loc))] <- 'size: LGC'#
# keyvals.shape[which(rownames(locres1s) %in% pull(sm.loc))] <- 1#
# names(keyvals.shape)[which(rownames(locres1s) %in% pull(sm.loc))] <- 'size: SGC'#
EnhancedVolcano(locres1s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
locres2s <- lfcShrink(ddsnog, coef="group", type="apeglm")
resultsNames(ddsnog)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
locres2s <- lfcShrink(ddsnog, coef="size_small_vs_large", type="apeglm")
ddsnog
resultsNames(ddsnog)
resultsNames(ddsno)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
locres2s <- lfcShrink(ddsno, coef="size_small_vs_large", type="apeglm")
results(ddsnog)
results(ddsnog,contrast=0)
results(ddsnog,contrast=1)
results(ddsnog,contrast=c(1,1,0,0,0))
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
EnhancedVolcano(locres2s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
EnhancedVolcano(locres1s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
s<-sno.sm.local#
s[which(s$padj<0.1),] # replace s to calculate for the comparisons above
s<-sno.lg.local#
s[which(s$padj<0.1),] # replace s to calculate for the comparisons above
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
locres3s <- lfcShrink(ddsnog, coef="group_largenucleus_vs_largecytosol",type="apeglm")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
EnhancedVolcano(locres3s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
locres4s <- lfcShrink(ddsnog, coef="group_smallnucleus_vs_smallcytosol",type="apeglm")
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
design(snoMat) <- ~group+Batch
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
ddsnog<-DESeq(snoMat)
resultsNames(ddsnog)
design(snoMat)
sno.size
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
locres4s <- lfcShrink(ddsnog, type="apeglm")
?lfcShring
?lfcShrink
locres4s <- lfcShrink(ddsnog, res=results(ddsnog),type="apeglm")
results(ddsnog)
design(snoMat) <- ~Batch+group
ddsnog<-DESeq(snoMat)
results(ddsnog)
resultsNames(ddsnog)
snoMat$Group
snoMat$Groups
snoMat$group
snoMat$batch
snoMat$Batch
design(snoMat) <- ~subcell+batch#
ddsno2<-DESeq(snoMat)
locres5s <- lfcShrink(ddsno2, coef="subcell_nucleus_vs_cytosol", type="apeglm")
EnhancedVolcano(locres5s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
s<-sno.sm.local#
s<-s[which(s$padj<0.1),]#
# s<-s[which(s$log2FoldChange>0),] # nuclear enriched#
# s<-s[which(s$log2FoldChange<0),] # cytoplasm enriched#
sno.smV<-row.names(s)#
#
s<-sno.lg.local#
s<-s[which(s$padj<0.1),]#
sno.lgV<-row.names(s)
DESeq2::plotMA(locres1s, ylim = c(-2.8, 2.8), main="Relative abundance of snoRNA in the nucleus")#
with(locres1s[sno.lgV,], {#
    points(baseMean, log2FoldChange, col=ann_col$size[2], lwd=2)#
    text(baseMean, log2FoldChange, sno.lgV, pos=3, col=ann_col$size[2],cex=0.5)#
})#
with(locres1s[sno.smV,], {#
    points(baseMean, log2FoldChange, col=ann_col$size[1], lwd=2)#
    text(baseMean, log2FoldChange, sno.smV, pos=3, col=ann_col$size[1],cex=0.5)#
})
sno.lgV
sno.smV
venn.diagram(x=list("SGC"=sno.smV,"LGC" = sno.lgV),fill=ann_col$size,filename=NULL) -> venny#
grid.draw(venny)#
anti_join(tbl_df(sno.smV),tbl_df(sno.lgV)) # identifies different miRNA (depends on the order of the tbl)
grid.draw(venny)
sm.loc <- anti_join(tbl_df(sno.smV),tbl_df(sno.lgV))#
lg.loc <- anti_join(tbl_df(sno.lgV),tbl_df(sno.smV))
lg.loc
sm.loc
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
keyvals <- rep("grey",nrow(locres1s))#
names(keyvals) <- rep('similar expression',nrow(locres1s))
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
keyvals[which(rownames(locres1s) %in% pull(lg.loc))] <- ann_col$size[2]#
names(keyvals)[which(rownames(locres1s) %in% pull(lg.loc))] <- 'size: LGC'#
keyvals[which(rownames(locres1s) %in% pull(sm.loc))] <- ann_col$size[1]#
names(keyvals)[which(rownames(locres1s) %in% pull(sm.loc))] <- 'size: SGC'
setwd('/Users/derektoms/Documents/Manuscripts/Nuclear microRNA')
snoRAnnotate <- read.csv(file = "piRNA_snoRNA/snoRNA-RFAM.csv", header = TRUE, stringsAsFactors = FALSE)#
sno.names <- substring(snoRAnnotate$x,3)#
CD <- snoRAnnotate$x[which(snoRAnnotate$class=="C/D")]#
HACA <- snoRAnnotate$x[which(snoRAnnotate$class=="H/ACA")]#
#
keyvals.shape <- rep(16,nrow(locres1s))#
names(keyvals.shape) <- rep('uncategorized',nrow(locres1s))#
#
keyvals.shape[which(rownames(locres1s) %in% CD)] <- 17#
names(keyvals.shape)[which(rownames(locres1s) %in% CD)] <- 'C/D'#
#
keyvals.shape[which(rownames(locres1s) %in% HACA)] <- 15#
names(keyvals.shape)[which(rownames(locres1s) %in% HACA)] <- 'H/ACA'#
#
# keyvals.shape[which(rownames(locres1s) %in% pull(lg.loc))] <- 1#
# names(keyvals.shape)[which(rownames(locres1s) %in% pull(lg.loc))] <- 'size: LGC'#
# keyvals.shape[which(rownames(locres1s) %in% pull(sm.loc))] <- 1#
# names(keyvals.shape)[which(rownames(locres1s) %in% pull(sm.loc))] <- 'size: SGC'#
EnhancedVolcano(locres3s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
EnhancedVolcano(locres5s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
EnhancedVolcano(locres5s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1.5, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
miRReads$raw.count
class(miRReads$raw.count)
class(miRReads$col.dat)
miRNA <- function() {#
 return  miRReads#
}
miRNA <- function() {#
 return(miRReads)#
}
miRNA
miRNA()
?rnaseqGene
??rnaseqGene
class(miRReads)
snoRNA <- function() {#
 return(snoRReads)#
}
snoRNA()
sno_mat <- snoRNA()#
sno <- DESeqDataSetFromMatrix(countData = sno_mat$raw.count, colData = sno_mat$col.dat, design=~size*subcell+batch)#
#
sno.d <- DESeq(sno)#
#
## Full linear model, two factors#
size <- results(dds1, contrast=c("size","small","large"))#
local <- results(dds1, contrast=c("subcell","cytosol","nucleus"))#
sno.loc <- local[which(local$padj<0.1),]#
#
## Check distribution of p-values#
ggplot(as(local, "data.frame"), aes(x = pvalue)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0)
sno.loc <- local[which(local$padj<0.01),]
sno.loc
locTopTable<-sno.loc[order(sno.loc$log2FoldChange,decreasing=TRUE),]#
df <- data.frame(sno=rownames(lgTopTable),lfc=lgTopTable$log2FoldChange,se=lgTopTable$lfcSE)#
ggplot(df,aes(x=reorder(labs,lfc, sum),y=lfc))+geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) + scale_fill_manual(values=nuc_col) + coord_flip() + labs(title="LGC", x="", y=expression(log["2"]~"fold change (relative to nucleus)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
locTopTable<-sno.loc[order(sno.loc$log2FoldChange,decreasing=TRUE),]#
df <- data.frame(sno=rownames(locTopTable),lfc=locTopTable$log2FoldChange,se=locTopTable$lfcSE)#
ggplot(df,aes(x=reorder(labs,lfc, sum),y=lfc))#
+ geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black") #
+ geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) #
+ scale_fill_manual(values=nuc_col) + coord_flip() #
+ labs(title="LGC", x="", y=expression(log["2"]~"fold change (relative to nucleus)")) #
+ theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
ggplot(df,aes(x=reorder(labs,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) + scale_fill_manual(values=nuc_col) + coord_flip() + labs(title="LGC", x="", y=expression(log["2"]~"fold change (relative to nucleus)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
ggplot(df,aes(x=reorder(labs,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) + coord_flip() + labs(title="LGC", x="", y=expression(log["2"]~"fold change (relative to nucleus)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
df
sno.loc
size <- results(sno.d, contrast=c("size","small","large"))#
local <- results(sno.d, contrast=c("subcell","cytosol","nucleus"))
ggplot(as(local, "data.frame"), aes(x = pvalue)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0)
sno.loc <- local[which(local$padj<0.01),]#
locTopTable<-sno.loc[order(sno.loc$log2FoldChange,decreasing=TRUE),]#
df <- data.frame(sno=rownames(locTopTable),lfc=locTopTable$log2FoldChange,se=locTopTable$lfcSE)#
ggplot(df,aes(x=reorder(labs,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) + coord_flip() + labs(title="LGC", x="", y=expression(log["2"]~"fold change (relative to nucleus)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
df
ggplot(df,aes(x=reorder(labs,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black")
ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(labs,lfc, sum)),colour="black")
ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black")
ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) + coord_flip() + labs(title="LGC", x="", y=expression(log["2"]~"fold change (relative to nucleus)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
snoRAnnotate <- read.csv(file = "piRNA_snoRNA/snoRNA-RFAM.csv", header = TRUE, stringsAsFactors = FALSE)#
sno.names <- substring(snoRAnnotate$x,3)#
CD <- snoRAnnotate$x[which(snoRAnnotate$class=="C/D")]#
HACA <- snoRAnnotate$x[which(snoRAnnotate$class=="H/ACA")]#
#
keyvals.shape <- rep(16,nrow(locres1s))#
names(keyvals.shape) <- rep('uncategorized',nrow(locres1s))#
#
keyvals.shape[which(rownames(locres1s) %in% CD)] <- 17#
names(keyvals.shape)[which(rownames(locres1s) %in% CD)] <- 'C/D'#
#
keyvals.shape[which(rownames(locres1s) %in% HACA)] <- 15#
names(keyvals.shape)[which(rownames(locres1s) %in% HACA)] <- 'H/ACA'#
#
# keyvals.shape[which(rownames(locres1s) %in% pull(lg.loc))] <- 1#
# names(keyvals.shape)[which(rownames(locres1s) %in% pull(lg.loc))] <- 'size: LGC'#
# keyvals.shape[which(rownames(locres1s) %in% pull(sm.loc))] <- 1#
# names(keyvals.shape)[which(rownames(locres1s) %in% pull(sm.loc))] <- 'size: SGC'#
EnhancedVolcano(locres3s, lab=sno.names, x='log2FoldChange', y='pvalue', xlim=c(-3,3), FCcutoff = 1, colCustom=keyvals, shapeCustom=keyvals.shape, title = "Differences in snoRNA localization", transcriptLabSize = 4.0, transcriptPointSize =2, drawConnectors=TRUE, colConnectors="grey50", legendPosition='right', legendLabSize = 10, legendIconSize = 3.0)
sno.loc <- local[which(local$padj<0.01),]#
locTopTable<-sno.loc[order(sno.loc$log2FoldChange,decreasing=TRUE),]#
df <- data.frame(sno=rownames(locTopTable),lfc=locTopTable$log2FoldChange,se=locTopTable$lfcSE)#
p <- ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2)#
p <- p + coord_flip() + labs(title="snoRNA", x="", y=expression(log["2"]~"fold change (relative to cytoplasm)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")#
p
p <- p + coord_flip() + labs(title="snoRNA", x="", y=expression("Cytoplasmic enrichment ("~log["2"]~"fold change)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")#
p
p <- ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2)#
p <- p + coord_flip() + labs(title="snoRNA", x="", y=expression("Cytoplasmic enrichment ("~log["2"]~"fold change)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")#
p
p <- ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2)#
p <- p + coord_flip() + labs(title="snoRNA", x="", y=expression("Cytoplasmic enrichment (".log["2"]~"fold change)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")#
p
p <- ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2)#
p <- p + coord_flip() + labs(title="snoRNA", x="", y=expression("Cytoplasmic enrichment ("*log["2"]~"fold change)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")#
p
data()
mtcars
faithful
morley
smiths
kidney
miRReads$col.dat
snoRReads$col.dat
sno <- DESeqDataSetFromMatrix(countData = snoRReads$raw.count, colData = snoRReads$col.dat, design=~size*subcell+batch)#
#
## Full linear model, two factors#
sno.d <- DESeq(sno)#
#
size <- results(sno.d, contrast=c("size","small","large"))#
local <- results(sno.d, contrast=c("subcell","cytosol","nucleus"))#
#
## Check distribution of p-values#
ggplot(as(local, "data.frame"), aes(x = pvalue)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0)#
#
## Now plot the expression of those snoRNA with significant differences#
sno.loc <- local[which(local$padj<0.01),]#
locTopTable<-sno.loc[order(sno.loc$log2FoldChange,decreasing=TRUE),]#
df <- data.frame(sno=rownames(locTopTable),lfc=locTopTable$log2FoldChange,se=locTopTable$lfcSE)#
p <- ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2)#
p <- p + coord_flip() + labs(title="snoRNA", x="", y=expression("Cytoplasmic enrichment ("*log["2"]~"fold change)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")#
p
ggsave("s3RNA_lfc.png")
ggplot(as(local, "data.frame"), aes(x = pvalue)) + geom_histogram(binwidth = 0.01, fill = "darkslategray", boundary = 0)
ggsave("s3RNA_p-val.png")
ggplot(df,aes(x=reorder(sno,lfc, sum),y=lfc))+ geom_col(aes(fill=reorder(sno,lfc, sum)),colour="black") + geom_errorbar(aes(ymin=lfc-se,ymax=lfc+se),width=0.2) + coord_flip() + labs(title="snoRNA", x="", y=expression("Cytoplasmic enrichment ("*log["2"]~"fold change)")) + theme(axis.text.y = element_text(size=8,hjust=0), axis.ticks.y = element_blank(), legend.position="none")
setwd("s3RNA/")
devtools::use_data(miRReads,snoRReads)
library(devtools)
devtools::use_data(miRReads,snoRReads)
install.packages(devtools)
install.packages("devtools")
library(devtools)
devtools::use_data(miRReads,snoRReads)
use_data(miRReads,snoRReads)
devtools::create()
create()
library(usethis)
create()
create_package()
create_package(path=".")
cd..
setwd("..")
create_package(path="s3RNA")
getwd()
use_data(miRReads,snoRReads)
use_package("DESeq2","Suggests")
use_package("ggplot2","Suggests")
?diamonds
q()
